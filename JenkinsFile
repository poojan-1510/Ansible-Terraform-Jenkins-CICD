pipeline {
    agent any

    tools {
        maven "maven-lts"
    }

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'qa', 'prod'],
            description: 'Choose the deployment environment'
        )
    }

    environment {
        SONAR_HOST_URL = "http://10.0.2.197:9000"
        SONAR_TOKEN    = credentials('SONAR_CREDS')
        NEXUS_URL      = "http://10.0.2.87:8081/repository/maven-releases/"
        ARTIFACT_ID    = "simple-java-maven-app"
        AWS_REGION     = "us-east-2"

        IMAGE_TAG      = "${BUILD_NUMBER}"   // â† unique tag for each build
    }

    stages {

        stage('Set Environment Variables') {
            steps {
                script {
                    def envConfig = [
                        dev : [
                            ECR_REPO     : "523026302352.dkr.ecr.us-east-2.amazonaws.com/project1-app-dev",
                            CLUSTER_NAME : "project1-cluster",
                            SERVICE_NAME : "project1-app-service-dev"
                        ],
                        qa  : [
                            ECR_REPO     : "523026302352.dkr.ecr.us-east-2.amazonaws.com/project1-app-qa",
                            CLUSTER_NAME : "project1-cluster-qa",
                            SERVICE_NAME : "project1-app-service-qa"
                        ],
                        prod: [
                            ECR_REPO     : "523026302352.dkr.ecr.us-east-2.amazonaws.com/project1-app-prod",
                            CLUSTER_NAME : "project1-cluster-prod",
                            SERVICE_NAME : "project1-app-service-prod"
                        ]
                    ]

                    env.ECR_REPO       = envConfig[params.ENVIRONMENT].ECR_REPO
                    env.CLUSTER_NAME   = envConfig[params.ENVIRONMENT].CLUSTER_NAME
                    env.SERVICE_NAME   = envConfig[params.ENVIRONMENT].SERVICE_NAME

                    echo "Deploying to environment: ${params.ENVIRONMENT}"
                    echo "ECR_REPO: ${env.ECR_REPO}"
                    echo "CLUSTER_NAME: ${env.CLUSTER_NAME}"
                    echo "SERVICE_NAME: ${env.SERVICE_NAME}"
                }
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'master', url: 'https://github.com/jenkins-docs/simple-java-maven-app.git'
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean install -DskipTests'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonar-lts') {
                    sh "mvn sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN"
                }
            }
        }

        stage('Run Tests') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Package Artifact') {
            steps {
                sh 'mvn package'
                sh 'ls -l target/'
            }
        }

        stage('Deploy to Nexus') {
            steps {
                script {
                    def jarFile = sh(script: "ls target/*.jar | head -n 1", returnStdout: true).trim()
                    echo "Deploying JAR: ${jarFile}"

                    def version = "1.0.${env.BUILD_NUMBER}"
                    echo "Artifact version: ${version}"

                    withCredentials([usernamePassword(credentialsId: 'NEXUS-CRED',
                                                    usernameVariable: 'NEXUS_USER',
                                                    passwordVariable: 'NEXUS_PASS')]) {
                        sh """
                        mvn deploy:deploy-file \
                            -DartifactId=${ARTIFACT_ID} \
                            -Dversion=${version} \
                            -Dpackaging=jar \
                            -Dfile=${jarFile} \
                            -DrepositoryId=nexus-releases \
                            -Durl=${NEXUS_URL} \
                            -Dusername=${NEXUS_USER} \
                            -Dpassword=${NEXUS_PASS}
                        """
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def jarFile = sh(script: "ls target/*.jar | head -n 1", returnStdout: true).trim()
                    echo "Using JAR: ${jarFile}"

                    sh """
                    echo 'FROM openjdk:17-jdk-slim
                    COPY ${jarFile} /app/${ARTIFACT_ID}.jar
                    ENTRYPOINT ["java", "-jar", "/app/${ARTIFACT_ID}.jar"]' > Dockerfile

                    docker build -t ${ECR_REPO}:${IMAGE_TAG} .
                    docker tag ${ECR_REPO}:${IMAGE_TAG} ${ECR_REPO}:latest
                    """
                }
            }
        }

        stage('Push Docker Image to ECR') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'AWS-CRED',
                                                usernameVariable: 'AWS_ACCESS_KEY_ID',
                                                passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh """
                    aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO}

                    docker push ${ECR_REPO}:${IMAGE_TAG}
                    docker push ${ECR_REPO}:latest
                    """
                }
            }
        }

        stage('Deploy to Fargate') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'AWS-CRED',
                                                usernameVariable: 'AWS_ACCESS_KEY_ID',
                                                passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh """
                    aws ecs update-service \
                        --cluster ${CLUSTER_NAME} \
                        --service ${SERVICE_NAME} \
                        --force-new-deployment \
                        --region ${AWS_REGION}
                    """
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished."
        }
        failure {
            echo "Pipeline failed. Check the logs!"
        }
    }
}
